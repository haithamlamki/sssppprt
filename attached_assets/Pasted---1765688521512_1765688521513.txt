توزيع الفرق على المجموعات موجود فعلاً (أ/ب)، لكن منطق توليد/عرض المباريات لا يستخدم هذا التوزيع؛ لذلك تظهر مباريات “أ ضد ب” داخل مرحلة المجموعات، وهذا خطأ.

التشخيص الأقرب (حسب نمط المباريات اللي ظهرت عندك)

المباريات المعروضة (مثل: HUMAN CAPITAL vs Q&C) تدل أن النظام يعمل واحد من هذين الخطأين:

مولّد المباريات يكوّن جدول لـ 8 فرق ككل (بدون فلترة حسب المجموعة) ثم يوزّعهم زوجيًا.

أو أنه يطبّق منطق خروج مغلوب مبكر (A1 vs B2 …) بدل “دوري مجموعات”.

ما يجب أن يحدث في “مرحلة المجموعات”

لا تُنشأ أي مباراة إلا إذا كان:
team1.group_id == team2.group_id

لكل مجموعة (4 فرق) = 6 مباريات (3 جولات × 2 مباراة)

إذا أنت موزع الأيام يدويًا (3 أيام):
اليوم 1 = الجولة 1 للمجموعة أ + الجولة 1 للمجموعة ب
اليوم 2 = الجولة 2…
اليوم 3 = الجولة 3…
➡️ طبيعي يصير عندك 4 مباريات في اليوم (2 لكل مجموعة) لكن كلها داخل مجموعتها.

إصلاح “Top 0.1%” (يقفل الباب على هذا النوع من الأخطاء)
1) قيد صارم عند إنشاء مباريات المجموعات

قبل insert للمباراة:

إذا stage = GROUPS:

ارفض إنشاء المباراة إذا group_id مختلف

2) توليد المباريات يكون “لكل مجموعة” وليس لكل البطولة

3) إصلاح العرض (UI)

في صفحة “المباريات القادمة”:

اعرض فقط:

tournament_id = X

stage = GROUPS (إن كنت في تبويب المجموعات)

وأظهر Badge: (أ) أو (ب) بجانب كل مباراة.

ملاحظة مهمة جدًا من واقع صورك

توزيع المجموعات في صورة “مرحلة المجموعات” الأولى كان مختلف عن توزيع “الفرق المشاركة” الأخير.
هذا غالبًا يعني أحد أمرين:

إما أن هناك بيانات قديمة/كاش في صفحة المجموعات

أو أن جدول المجموعات يُقرأ من مصدر مختلف عن جدول “الفرق المشاركة”

الحل النخبوي هنا: اجعل “المجموعات” تُبنى دائمًا من teams.group_id كمصدر واحد للحقيقة، ولا تُخزَّن كمصفوفة ثانية منفصلة إلا للعرض فقط.
منطق عرض مباريات خروج المغلوب + منطق التعامل مع النقص (BYE / فرق غير مكتملة / مباريات غير محسومة) بطريقة تمنع تكرار أخطاء مرحلة المجموعات.

سأفترض عندك مراحل مثل: GROUPS و KNOCKOUT وأن عندك شاشة “قائمة المباريات” + شاشة “شجرة خروج المغلوب”.

1) قواعد منطق خروج المغلوب (المعيار العالمي)
تأهل من المجموعات

المتأهلون: عادة أول وثاني كل مجموعة

الترتيب داخل المجموعة: نقاط → فارق → أهداف → (أي Tie-breakers عندك)

توزيع مواجهات أول دور خروج مغلوب (Seeding)

لمنع إعادة مباريات المجموعة:

A1 vs B2

B1 vs A2

ثم:

الفائز من (A1/B2) يواجه الفائز من (B1/A2) في النهائي (أو نصف/نهائي حسب الحجم)

ملاحظة: في خروج المغلوب مسموح (أ ضد ب) عكس مرحلة المجموعات.

2) منطق عرض مباريات خروج المغلوب في قائمة المباريات
فلترة صحيحة حسب المرحلة

في تبويب “خروج المغلوب”: اعرض فقط مباريات stage = KNOCKOUT

لا تعتمد على group_id هنا (قد يكون null أو “KO”)

ترتيب العرض

حسب الجولة ثم حسب التاريخ ثم حسب رقم المباراة

الجولات تكون مثل:

Round of 16

Quarterfinal

Semifinal

Final

حالات العرض (مهم جدًا)

إذا طرف المباراة غير معروف بعد (TBD):

اعرضها كـ: Winner Match #3 vs Winner Match #4

أو: TBD vs TBD

إذا لم تُحدد التواريخ (لأنك توزع يدويًا):

اعرض الجولة بدون تاريخ أو ضع “غير مجدول”

قواعد ذهبية للـ UI

Badge ثابت: (خروج مغلوب – نصف النهائي) … إلخ

أظهر “مصدر التأهل” (A1, B2, Winner M5…) لأن هذا يحل 80% من اللبس عند المستخدمين

3) منطق الشجرة (Bracket) — صحيح وقابل للتوسع
تمثيل البيانات (أفضل ممارسة)

لكل مباراة خروج مغلوب خزّن:

id

stage = KNOCKOUT

round (مثلاً: SF, F)

home_participant_type + home_participant_ref

away_participant_type + away_participant_ref

حيث participant_type يكون واحد من:

TEAM (فريق مباشر)

GROUP_SLOT (مثل A1, B2)

WINNER_OF_MATCH (مثل Winner of Match 12)

وهذا يمنع “النقص” في العرض لأن المباراة يمكن عرضها حتى قبل معرفة الفرق.

4) منطق “النقص” (BYE / عدد فرق غير مناسب)

إذا عدد المتأهلين ليس قوة 2 (2,4,8,16…)، نطبق BYE.

حساب BYE

n = عدد المتأهلين

p = أصغر قوة 2 أكبر أو تساوي n

byes = p - n

كيف نطبقها؟

أعلى seeds (الأفضل ترتيبًا) يأخذون BYE تلقائيًا للدور التالي

تُنشأ مباريات أقل في الدور الأول

في الشجرة: يظهر فريق + “BYE” أو ينتقل مباشرة للدور التالي

عرض الـ UI

مباراة: TEAM X مقابل BYE (وتُسجل نتيجتها إداريًا كفوز تلقائي)

أو لا تُنشئ مباراة وتضع الفريق مباشرة بالدور التالي (أفضل تقنيًا)

5) خوارزمية توليد خروج المغلوب (مع/بدون نقص)
A) الحالة الطبيعية عندك (8 فرق / مجموعتين / يتأهل 4)

متأهلون: A1, A2, B1, B2

نصف نهائي:

M1: A1 vs B2

M2: B1 vs A2

نهائي:

M3: Winner(M1) vs Winner(M2)
6) الربط التلقائي: تعبئة “Winner of Match”

بعد تسجيل نتيجة مباراة خروج مغلوب:

حدّد الفائز

ابحث عن كل مباراة فيها participant_ref = WINNER_OF_MATCH(this_match_id)

املأ الفريق تلقائيًا
7) أهم سبب يسبب “خربطة العرض” عندكم (وخلاصته)

لازم تفصل بين:

منطق التوليد (Groups vs Knockout)

منطق العرض (فلترة حسب stage + عرض placeholders)

إذا عرضت مباريات خروج المغلوب بنفس منطق المجموعات (فرق لازم تكون موجودة الآن)، ستشوف “نقص” وحقول فاضية وتضيع الشجرة.

واضف خيار تفعيل مبارة تحديد المركز الثالث
