المشكلة هنا ليست “عرض” فقط—هي فصل بيانات المجموعات عن بيانات المباريات:

أنت تغيّر مجموعة الفريق في صفحة “الفرق المشاركة” ✅

لكن “المباريات القادمة” تُقرأ من مباريات تم توليدها سابقًا (أو من جدول/كاش آخر) ولا يتم إعادة توليدها أو تحديثها بعد تغيير المجموعة ❌
لذلك طبيعي ما ينعكس التغيير.

المنطق الصحيح (كيف لازم يشتغل النظام)
قاعدة ذهبية

مباريات مرحلة المجموعات يجب أن تُولّد وتُعرض بناءً على team.group_id الحالي (مصدر حقيقة واحد).

إصلاح عملي 1: تحديث/إعادة توليد مباريات المجموعات عند تغيير المجموعة

عند تعديل مجموعة فريق (Team.group_id):

الخيار A (الأفضل والأسهل لضمان الصحة)

احذف كل مباريات مرحلة المجموعات “غير المنتهية” للبطولة

أعد توليدها من جديد بناءً على توزيع المجموعات الحالي

متى؟ مباشرة بعد حفظ تغيير المجموعة أو عند ضغط زر “توليد مباريات المجموعات”.

SQL منطقي (تقريبي):

DELETE FROM matches
WHERE tournament_id = :tid
  AND stage = 'GROUPS'
  AND status IN ('SCHEDULED','PENDING');  -- حسب نظامك


ثم توليد Round-robin لكل مجموعة على حدة.

إصلاح عملي 2: حتى لو لم تُعد التوليد… لازم العرض يكون صحيح

في شاشة “المباريات القادمة” لمرحلة المجموعات:

لازم تكون فلترة العرض بهذا الشكل

اعرض مباريات stage='GROUPS'

ومع كل مباراة اعرض اسم المجموعة من match.group_id (وليس من team فقط)

وإذا أنت لا تخزّن group_id داخل match:

هنا أصل المشكلة: المباراة لا تعرف أنها “مجموعة أ” أو “ب” ⇒ لازم تضيفها.

أهم تعديل “Top 0.1%” يمنع تكرار المشكلة (قيود + نموذج بيانات)
1) خزّن group_id داخل المباراة في مرحلة المجموعات

عند إنشاء مباراة Groups:

match.group_id = home_team.group_id (ويجب يساوي away_team.group_id)

2) ضع قيد يمنع Cross-group داخل Groups (يحميك من أي خطأ برمجي)

منطق تطبيق/DB:

إذا stage='GROUPS' و home.group_id != away.group_id ⇒ ارفض الإنشاء

3) أضف حقل “إصدار/نسخة” لتوزيع المجموعات (اختياري لكن ممتاز)

grouping_version على مستوى البطولة

كل مرة تغيّر توزيع المجموعات: version++

كل مباراة Groups تُخزن معها grouping_version

شاشة المباريات تعرض فقط مباريات آخر نسخة

هذا يحل مشكلة “المباريات القديمة” بدون حذف فعلي.

لماذا ظهرت عندك مباريات أ ضد ب؟

لأن المولد غالبًا يعمل على كل الفرق (8) بدل:

فرق المجموعة أ وحدها (4)

ثم فرق المجموعة ب وحدها (4)

وهذا ينتج مواجهات عشوائية Cross-group مثل التي ظهرت.

Reframe سريع

بدل ما تعتبر “المجموعة” خاصية شكلية في صفحة الفرق…
اعتبرها مدخل أساسي يولّد منه جدول مباريات جديد.
أي تغيير في المجموعات = تغيير في “هيكل البطولة”، وليس مجرد تعديل بيانات.

خطوات تنفيذ مختصرة (جاهزة للمطور)

عند حفظ تغيّر group لفريق:

markTournamentGroupsDirty(tournament_id)

عند فتح تبويب “المباريات” أو الضغط “توليد مباريات”:

إذا groupsDirty=true:

delete scheduled group matches

regenerate per group

set groupsDirty=false